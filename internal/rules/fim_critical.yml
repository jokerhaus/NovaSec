# internal/rules/fim_critical.yml
# Правило для обнаружения критических изменений файлов (FIM)

id: "fim_critical"
name: "Critical File Integrity Monitoring"
description: "Обнаруживает изменения критически важных системных файлов"
severity: "critical"
enabled: true

window:
  duration: "1m"
  sliding: false

group_by: ["host", "file_path", "sha256"]

threshold:
  count: 1
  type: "count"
  field: ""

suppress:
  duration: "2m"
  key: "rule_id + host + file_path + sha256"

conditions:
  - field: "category"
    operator: "equals"
    value: "file"
    invert: false
  
  - field: "subtype"
    operator: "equals"
    value: "modify"
    invert: false
  
  - field: "file_path"
    operator: "in"
    value: "/etc/shadow,/etc/sudoers,/etc/passwd,/etc/group"
    invert: false

actions:
  - type: "alert"
    config:
      title: "Critical File Modification Detected"
      description: "Critical system file has been modified"
      severity: "critical"
    delay: "0s"
    retry: 3
    timeout: "30s"
  
  - type: "notify"
    config:
      channels: ["email", "telegram", "webhook"]
      template: "fim_critical"
      immediate: true
    delay: "0s"
    retry: 2
    timeout: "10s"
  
  - type: "block"
    config:
      action: "isolate_host"
      duration: "1h"
    delay: "0s"
    retry: 1
    timeout: "5s"

metadata:
  tags: ["fim", "file_integrity", "critical", "system"]
  references:
    - "https://attack.mitre.org/techniques/T1005/"
    - "https://attack.mitre.org/techniques/T1005/001/"
  priority: 1
  category: "file_integrity"
  mitre_technique: "T1005.001"
  response_time: "immediate"
